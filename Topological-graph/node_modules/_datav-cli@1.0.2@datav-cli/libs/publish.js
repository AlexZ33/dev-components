var path    = require('path');
var pack    = require('./utils/pack');
var request = require('./utils/request');
var auth    = require('./utils/auth');
var ini     = require('ini');
var log     = require('./utils/log');
var ServiceClient = require('./utils/service-client');
var formstream = require('formstream');

module.exports = function(config, root, args) {
  if (typeof root !== 'string') {
    args = root;
    root = process.cwd();
  } else {
    root = path.join(process.cwd(), root);
  }
  // log.debug('region', args.region, root)
  let region = args && args.region || config.regionDefault;
  var token;
  log.info('正在进行 region: ' + region + ' 的发布');

  auth.check(function(err, authObj) {
    if (err || !authObj || !authObj[region]) {
      return log.err(err || 'no permission.')
    }
    authObj = authObj[region];
    token = authObj.token;
    var packageCFG;
    if (!token) return log.err('您还没有key, 请先用[datav set-key]命令设置key.');
    try {
      packageCFG = require(path.join(root, 'package.json'));
    } catch(e) {
      return log.err('parse package.json failed')
    }
    pack(packageCFG, path.join(config.root, config.cacheDir), root, config, function(err, tarPath) {
      if (err) {
        return log.err(err);
      } else {
        let authArrs = token.split(':');
        if (!authArrs.length || authArrs.length < 2) return log.err('您还没有key, 请先用[datav set-key]命令设置key.');
        let userGroupId = authArrs[0];
        let regionName = authArrs[1];
        let regionURL = config.region[regionName];
        if (!regionURL) return log.err('region错误，请重新核对.')
        let to = token.substr(userGroupId.length + authArrs[1].length + 2);
        var client = new ServiceClient({
          endpoint: config.server_root,
          token: to,
          debug: false
        });
        var form = formstream();
        form.file('package', tarPath);
        form.field('name', packageCFG.name);
        form.field('version', packageCFG.version);
        form.field('username', authObj.username);
        form.field('userGroupId', parseInt(userGroupId));
        form.field('region', authObj.region);
        log.debug(`${userGroupId}发布${packageCFG.name}@${packageCFG.version}中, 发布到${regionURL}`);
        log.info('发布中...');
        client.post(regionURL + '/cube/upload', (err, data, res) => {
          if (err) {
            log.err(err)
            if (data) log.info(data.toString('utf8'));
          } else {
            var msg = data.toString('utf8')
            if (msg) log.info(msg);
            else log.info('upload successed!');
          }
        }, {dataType: 'String', stream: form, timeout: 5*60*1000, headers: form.headers()})
      }
    });
  });
}
