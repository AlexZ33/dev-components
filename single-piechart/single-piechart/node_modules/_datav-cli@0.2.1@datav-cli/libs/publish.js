var root    = process.cwd();
var path    = require('path');
var fs      = require('fs-extra');
var pack    = require('./utils/pack');
var request = require('./utils/request');
var auth    = require('./utils/auth');
var npm     = require('npm');

module.exports = function(){
  auth.check(function(err){
    if (err) return console.error(err);
    console.log('install npm dependencies');
    npmInstall(function(err){
      if(err) {
        return console.error(err);
      }
      try {
        var config = require(path.join(root, 'package.json'));
      } catch(e) {
        return console.error('parse package.json failed')
      }
      var params = {
        name: config.name,
        version: config.version
      }
      pack(config.name, config.version, path.join(__dirname, '../', 'cache'), function(err, tarPath){
        if(err) {
          return console.error(err);
        } else {
          request.upload(params, tarPath, function (err, data){
            if (err) {
              console.log(err)
            if(data) console.log(data.toString('utf8'));
            } else {
              var msg = data.toString('utf8')
              if (msg) console.log(msg);
              else console.log('upload successed!');
            }
          });
        }
      });
    });
  });
}

function npmInstall (callback) {
  return callback();
  try {
    var config = require(path.join(root, 'package.json'));
  } catch(e) {
    callback('parse package.json failed')
  }
  npm.load(config, function(err) {
    if(err) { return callback('package.json failed') }
    npm.commands.install([], function(err){
      if(err) { return callback('npm install failed') }
      callback();
    })
  });
}
