var fs        = require('fs-extra');
var path      = require('path');
var tokenFile = path.join(getUserHome(), '.maliang.token');
var md5       = require('md5');

function getUserHome() {
  return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
}

module.exports.check = function(callback){
  fs.readFile(tokenFile, function(err, data){
    if (err) {
      callback('no permission');
    } else {
      callback();
    }
  })
}

module.exports.request = function(form, callback){
  fs.readFile(tokenFile, function(err, data){
    if (!err) {
      var time = (new Date()).getTime();
      form.field('token', md5(data.toString().trim() + time));
      form.field('tokentime', time);
    }
    callback(err, form);
  });
}
