var fs       = require('fs-extra');
var pack     = require('tar-pack').pack;
var path     = require('path');

module.exports = function(name, version, tarPath, callback) {
  tarPath = path.join(tarPath, '/'+name.replace('/', '#')+'-'+version+'.tar.gz');
  return pack(process.cwd(), {
      filter: function(entry){
        entry.ignoreRules = entry.ignoreRules || [];
        entry.ignoreRules.push('node_module');
        return entry;
      }
    })
    .pipe(fs.createOutputStream(tarPath))
    .on('error', function (err) {
      callback(err)
    })
    .on('close', function () {
      callback(null, tarPath);
    });
}
